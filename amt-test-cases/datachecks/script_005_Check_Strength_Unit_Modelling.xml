<!DOCTYPE suite SYSTEM "http://testng.org/testng-1.0.dtd" >

<suite name="script_005_Check_Strength_Unit_Modelling" verbose="2">
    <test name="005 All uses of a substance (within the same UoM heirarchy) reference the same strength unit">
        <parameter name="query" value="
SELECT DISTINCT multiunitstrength.substanceid, str.value1
  FROM (SELECT substanceunit.destinationid AS substanceid, COUNT(*)
          FROM (SELECT DISTINCT
                       hasAuBoss.destinationid AS destinationid,
                       CONVERT(
                          CONCAT(
                             '',
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'area unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'volume unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'mass unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'type of international unit')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'biological unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'microbiological culture unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'descriptive unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'hour')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = '16 hours')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = '24 hours')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'time unit of measure')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'type of pharmacopoeial unit')),
                             ISDESCENDENTOF_CR(
                                numUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'radiation activity unit of measure')),
                             denUnits.destinationid IS NULL,
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'area unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'volume unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'mass unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'type of international unit')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'biological unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'microbiological culture unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'descriptive unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'hour')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = '16 hours')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = '24 hours')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term = 'time unit of measure')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'type of pharmacopoeial unit')),
                             ISDESCENDENTOF_CR(
                                denUnits.destinationid,
                                (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE     moduleid = 900062011000036108
                                        AND term =
                                               'radiation activity unit of measure'))) USING UTF8)
                          AS hierarchyKey
                  FROM &lt;PROSPECTIVE&gt;.relationship_&lt;SNAPSHOT&gt; hasAuBoss
                       JOIN rf2_cr_ccsRefset_snapshot strength
                          ON     strength.referencedcomponentid =
                                    hasAuBoss.id
                             AND strength.active = 1
                             AND strength.refsetid =
                                    (SELECT DISTINCT conceptid
                                       FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                      WHERE term = 'strength reference set')
                       JOIN &lt;PROSPECTIVE&gt;.relationship_&lt;SNAPSHOT&gt; numUnits
                          ON     strength.value1 = numUnits.sourceid
                             AND numUnits.typeid =
                                    (SELECT DISTINCT conceptid
                                       FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                      WHERE term = 'has numerator units')
                             AND numUnits.active = 1
                       LEFT OUTER JOIN &lt;PROSPECTIVE&gt;.relationship_&lt;SNAPSHOT&gt; denUnits
                          ON     strength.value1 = denUnits.sourceid
                             AND denUnits.typeid =
                                    (SELECT DISTINCT conceptid
                                       FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                      WHERE term = 'has denominator units')
                             AND denUnits.active = 1
                 WHERE     hasAuBoss.typeid =
                              (SELECT DISTINCT conceptid
                                 FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                WHERE term = 'has Australian BoSS')
                       AND hasAuBoss.active = 1) AS substanceunit
        GROUP BY substanceunit.destinationid, substanceunit.hierarchyKey
        HAVING COUNT(*) > 1) AS multiunitstrength
       JOIN &lt;PROSPECTIVE&gt;.relationship_&lt;SNAPSHOT&gt; bossRel
          ON     bossRel.typeid = (SELECT DISTINCT conceptid
                                     FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                    WHERE term = 'has Australian BoSS')
             AND bossRel.active = 1
             AND bossRel.destinationid = multiunitstrength.substanceid
       JOIN rf2_cr_ccsRefset_snapshot str
          ON     str.referencedcomponentid = bossRel.id
             AND str.active = 1
             AND str.refsetid = (SELECT DISTINCT conceptid
                                   FROM &lt;PROSPECTIVE&gt;.descriptions_&lt;SNAPSHOT&gt;
                                  WHERE term = 'strength reference set')
ORDER BY multiunitstrength.substanceid;
        "/>
        <parameter name="resultCount" value="null"/>
        <parameter name="skip" value="true"/> <!--Uses a function or proc that needs refactoring-->
        <classes>
            <class name="au.gov.nehta.test.ResultCountTest"/>
        </classes>
    </test>

</suite>

